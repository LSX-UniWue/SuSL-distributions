from typing import Literal, Tuple

from anndata import AnnData
from scanpy import read_h5ad
from scanpy.preprocessing import filter_cells, normalize_total, log1p, highly_variable_genes
from torch import Tensor, tensor, from_numpy
from torch.utils.data import Dataset


def get_highly_variable_genes(data: AnnData) -> Tensor:
    normalize_total(data, target_sum=1e4)
    log1p(data)
    hvg = highly_variable_genes(data, min_mean=0.0125, max_mean=3, min_disp=0.5, inplace=False).highly_variable.values
    print(f"Using {hvg.sum()} genes; Out of {hvg.size}")
    return tensor(hvg)


class TabulaMurisDataset(Dataset):
    resource = "datasets_processed/tabula-muris.h5ad"
    label_column = "cell_ontology_class"
    classes = [
        "B cell",
        "DN1 thymic pro-T cell",
        "Fraction A pre-pro B cell",
        "Langerhans cell",
        "T cell",
        "alveolar macrophage",
        "basal cell",
        "basal cell of epidermis",
        "basophil",
        "bladder cell",
        "bladder urothelial cell",
        "blood cell",
        "cardiac muscle cell",
        "ciliated columnar cell of tracheobronchial tree",
        "classical monocyte",
        "dendritic cell",
        "duct epithelial cell",
        "early pro-B cell",
        "endocardial cell",
        "endothelial cell",
        "endothelial cell of hepatic sinusoid",
        "epithelial cell",
        "erythroblast",
        "fibroblast",
        "granulocyte",
        "granulocytopoietic cell",
        "hematopoietic precursor cell",
        "hepatocyte",
        "immature B cell",
        "immature T cell",
        "keratinocyte",
        "kidney capillary endothelial cell",
        "kidney cell",
        "kidney collecting duct epithelial cell",
        "kidney loop of Henle ascending limb epithelial cell",
        "kidney proximal straight tubule epithelial cell",
        "late pro-B cell",
        "leukocyte",
        "luminal epithelial cell of mammary gland",
        "lung endothelial cell",
        "macrophage",
        "mast cell",
        "mesangial cell",
        "mesenchymal cell",
        "mesenchymal stem cell",
        "monocyte",
        "myeloid cell",
        "natural killer cell",
        "neuroendocrine cell",
        "non-classical monocyte",
        "proerythroblast",
        "promonocyte",
        "skeletal muscle satellite cell",
        "stromal cell",
        "type II pneumocyte",
    ]

    def __init__(
        self,
        stage: Literal["train", "train_u", "val", "test"],
        **kwargs,
    ) -> None:
        data = read_h5ad(self.resource)
        # Can only call filter_cells with one argument -> do one call per argument
        for k, v in kwargs.items():
            filter_cells(data=data, **{k: v})
        self.__hvg = get_highly_variable_genes(data.copy())
        match stage:
            case "train_u":
                data = data[data.obs["train_mode"] == 0]
            case "train":
                data = data[data.obs["train_mode"] == 1]
            case "val":
                data = data[data.obs["train_mode"] == 2]
            case "test":
                data = data[data.obs["train_mode"] == 3]
        self.__x_data = from_numpy(data.X.todense())
        self.__y_data = list(map(self.classes.index, data.obs[self.label_column]))

    def __len__(self) -> int:
        return self.__x_data.shape[0]

    def __getitem__(self, idx: int) -> Tuple[Tensor, int]:
        x = self.__x_data[idx][self.__hvg]
        y = self.__y_data[idx]
        return x, y


class TabulaMurisSenisDataset(TabulaMurisDataset):
    resource = "datasets_processed/tabula-muris-senis.h5ad"
    classes = [
        "B cell",
        "CD4-positive, alpha-beta T cell",
        "CD8-positive, alpha-beta T cell",
        "DN3 thymocyte",
        "DN4 thymocyte",
        "Kupffer cell",
        "Langerhans cell",
        "NK cell",
        "Schwann cell",
        "T cell",
        "adventitial cell",
        "alveolar macrophage",
        "basal cell",
        "basal cell of epidermis",
        "basal epithelial cell of tracheobronchial tree",
        "basophil",
        "bladder cell",
        "bladder urothelial cell",
        "blood cell",
        "bronchial smooth muscle cell",
        "brush cell",
        "cardiac neuron",
        "cardiomyocyte",
        "chondrocyte",
        "ciliated columnar cell of tracheobronchial tree",
        "classical monocyte",
        "club cell of bronchiole",
        "dendritic cell",
        "double negative T cell",
        "duct epithelial cell",
        "endocardial cell",
        "endothelial cell",
        "endothelial cell of coronary artery",
        "endothelial cell of hepatic sinusoid",
        "endothelial cell of lymphatic vessel",
        "enterocyte of epithelium of large intestine",
        "epidermal cell",
        "epithelial cell",
        "epithelial cell of large intestine",
        "epithelial cell of proximal tubule",
        "erythroblast",
        "erythrocyte",
        "erythroid progenitor",
        "fenestrated cell",
        "fibroblast",
        "fibroblast of cardiac tissue",
        "fibroblast of lung",
        "granulocyte",
        "granulocytopoietic cell",
        "hematopoietic precursor cell",
        "hematopoietic stem cell",
        "hepatic stellate cell",
        "hepatocyte",
        "immature B cell",
        "immature NKT cell",
        "immature T cell",
        "intermediate monocyte",
        "intestinal crypt stem cell",
        "keratinocyte",
        "keratinocyte stem cell",
        "kidney capillary endothelial cell",
        "kidney cell",
        "kidney collecting duct epithelial cell",
        "kidney collecting duct principal cell",
        "kidney cortex artery cell",
        "kidney distal convoluted tubule epithelial cell",
        "kidney loop of Henle ascending limb epithelial cell",
        "kidney loop of Henle thick ascending limb epithelial cell",
        "kidney mesangial cell",
        "kidney proximal convoluted tubule epithelial cell",
        "kidney proximal straight tubule epithelial cell",
        "large intestine goblet cell",
        "late pro-B cell",
        "leukocyte",
        "luminal epithelial cell of mammary gland",
        "lung macrophage",
        "lung neuroendocrine cell",
        "lymphocyte",
        "macrophage",
        "macrophage dendritic cell progenitor",
        "mast cell",
        "mature NK T cell",
        "megakaryocyte-erythroid progenitor cell",
        "mesenchymal cell",
        "mesenchymal progenitor cell",
        "mesenchymal stem cell",
        "mesenchymal stem cell of adipose",
        "monocyte",
        "myeloid cell",
        "myeloid dendritic cell",
        "myeloid leukocyte",
        "naive B cell",
        "naive T cell",
        "neuroendocrine cell",
        "neutrophil",
        "non-classical monocyte",
        "pancreatic A cell",
        "pancreatic B cell",
        "pancreatic D cell",
        "pancreatic PP cell",
        "pancreatic acinar cell",
        "pancreatic ductal cel",
        "pancreatic stellate cell",
        "pericyte cell",
        "plasma cell",
        "plasmacytoid dendritic cell",
        "podocyte",
        "precursor B cell",
        "proerythroblast",
        "professional antigen presenting cell",
        "promonocyte",
        "pulmonary interstitial fibroblast",
        "regulatory T cell",
        "skeletal muscle cell",
        "skeletal muscle satellite cell",
        "smooth muscle cell",
        "smooth muscle cell of the pulmonary artery",
        "smooth muscle cell of trachea",
        "stem cell of epidermis",
        "stromal cell",
        "thymocyte",
        "type II pneumocyte",
        "vein endothelial cell",
    ]


class TabulaMurisMixtureDataset(TabulaMurisDataset):
    resource = "datasets_processed/tabula-muris-mixture.h5ad"
    classes = [
        "B cell",
        "CD4-positive, alpha-beta T cell",
        "CD8-positive, alpha-beta T cell",
        "DN1 thymic pro-T cell",
        "DN3 thymocyte",
        "DN4 thymocyte",
        "Fraction A pre-pro B cell",
        "Kupffer cell",
        "Langerhans cell",
        "NK cell",
        "Schwann cell",
        "T cell",
        "adventitial cell",
        "alveolar macrophage",
        "basal cell",
        "basal cell of epidermis",
        "basal epithelial cell of tracheobronchial tree",
        "basophil",
        "bladder cell",
        "bladder urothelial cell",
        "blood cell",
        "bronchial smooth muscle cell",
        "brush cell",
        "cardiac muscle cell",
        "cardiac neuron",
        "cardiomyocyte",
        "chondrocyte",
        "ciliated columnar cell of tracheobronchial tree",
        "classical monocyte",
        "club cell of bronchiole",
        "dendritic cell",
        "double negative T cell",
        "duct epithelial cell",
        "early pro-B cell",
        "endocardial cell",
        "endothelial cell",
        "endothelial cell of coronary artery",
        "endothelial cell of hepatic sinusoid",
        "endothelial cell of lymphatic vessel",
        "enterocyte of epithelium of large intestine",
        "epidermal cell",
        "epithelial cell",
        "epithelial cell of large intestine",
        "epithelial cell of proximal tubule",
        "erythroblast",
        "erythrocyte",
        "erythroid progenitor",
        "fenestrated cell",
        "fibroblast",
        "fibroblast of cardiac tissue",
        "fibroblast of lung",
        "granulocyte",
        "granulocytopoietic cell",
        "hematopoietic precursor cell",
        "hematopoietic stem cell",
        "hepatic stellate cell",
        "hepatocyte",
        "immature B cell",
        "immature NKT cell",
        "immature T cell",
        "intermediate monocyte",
        "intestinal crypt stem cell",
        "keratinocyte",
        "keratinocyte stem cell",
        "kidney capillary endothelial cell",
        "kidney cell",
        "kidney collecting duct epithelial cell",
        "kidney collecting duct principal cell",
        "kidney cortex artery cell",
        "kidney distal convoluted tubule epithelial cell",
        "kidney loop of Henle ascending limb epithelial cell",
        "kidney loop of Henle thick ascending limb epithelial cell",
        "kidney mesangial cell",
        "kidney proximal convoluted tubule epithelial cell",
        "kidney proximal straight tubule epithelial cell",
        "large intestine goblet cell",
        "late pro-B cell",
        "leukocyte",
        "luminal epithelial cell of mammary gland",
        "lung endothelial cell",
        "lung macrophage",
        "lung neuroendocrine cell",
        "lymphocyte",
        "macrophage",
        "macrophage dendritic cell progenitor",
        "mast cell",
        "mature NK T cell",
        "megakaryocyte-erythroid progenitor cell",
        "mesangial cell",
        "mesenchymal cell",
        "mesenchymal progenitor cell",
        "mesenchymal stem cell",
        "mesenchymal stem cell of adipose",
        "monocyte",
        "myeloid cell",
        "myeloid dendritic cell",
        "myeloid leukocyte",
        "naive B cell",
        "naive T cell",
        "natural killer cell",
        "neuroendocrine cell",
        "neutrophil",
        "non-classical monocyte",
        "pancreatic A cell",
        "pancreatic B cell",
        "pancreatic D cell",
        "pancreatic PP cell",
        "pancreatic acinar cell",
        "pancreatic ductal cel",
        "pancreatic stellate cell",
        "pericyte cell",
        "plasma cell",
        "plasmacytoid dendritic cell",
        "podocyte",
        "precursor B cell",
        "proerythroblast",
        "professional antigen presenting cell",
        "promonocyte",
        "pulmonary interstitial fibroblast",
        "regulatory T cell",
        "skeletal muscle cell",
        "skeletal muscle satellite cell",
        "smooth muscle cell",
        "smooth muscle cell of the pulmonary artery",
        "smooth muscle cell of trachea",
        "stem cell of epidermis",
        "stromal cell",
        "thymocyte",
        "type II pneumocyte",
        "vein endothelial cell",
    ]


if __name__ == "__main__":
    ds = TabulaMurisDataset(stage="train", min_counts=1000, min_genes=500)
    print(ds[1501])
